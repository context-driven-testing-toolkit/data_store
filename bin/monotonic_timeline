#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

# Generate a momotonic timeline.

# monotonic_timeline <from date> <until date> <increment size>

# The result lines look as follows. Both payloads of interval.epoch can hydrate a DATETIME object.
#
#    .interval.epoch: { "interval": { "epoch": INT, "string": STRING }, "events" : [] },
#
# The stringified date in STRING is UTC and ISO-8601 formatted.
#
# The lines are returned inside an onject like this:
#
#    { meta: { history: { start: DATETIME, end: DATETIME }, increment: STRING },
#      timeline: [] }
#
# Where .timeline contains the lines of the timeline descending order.

if [ -z "${3-}" ]
then
  echo "Usage: $(basename "${0-}") <from date> <until date> <increment size>"
  exit 1
fi

origin=$(date -u -d "${1}" --iso-8601=s)

terminus=$(date -u -d "${2}" --iso-8601=s)

dateseq --compute-from-last "$origin" "${3}" "$terminus" \
        -f '{"%s": {"interval": {"epoch": %s, "string": "%FT%T%Z"}}, "events": []}' \
        | jq -ec .
